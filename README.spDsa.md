SharePoint Data Service Adapter
===============================
Provides BreezeJS support for SharePoint 2010 & 2013+ (including SharePoint Online in Office 365).

The [breeze labs github repo](https://github.com/Breeze/breeze.js.labs.git "breeze labs on github") holds the latest official release.

See [Andrew Connell's on-going blog posts](http://www.andrewconnell.com/blog/breezejs-makes-client-side-sharepoint-2013-rest-development-a-breeze "Andrew's blog") for the latest information and indepth discussion of Breeze/Angular/SharePoint/Office365 development, including future plans & milestones.


Installation
------------
The Breeze data service adapter for SharePoint is provided as a single NuGet Package that includes everything you need to use it in a SharePoint 2010 or 2013+ project.

````powershell
Install-Package "Breeze.DataService.SharePoint"
````



Setup
-----
1. Add the necessary Breeze JavaScript libraries to the server.
1. Configure BreezeJS SharePoint data service adapter
1. Create & populate the BreezeJS metadata store
1. Initialize BreezeJS
1. Perform a Query



###Step 1 - Add necessary JavaScript Library References

````html
<!-- available in the base Breeze.js client package -->
<script src="breeze.debug.js" type="application/javascript"></script>

<!-- available in the base Breeze.js client, only needed if you are using Angular -->
<script src="breeze.bridge.angular.js" type="application/javascript"></script>

<!-- available from Breeze Labs -->
<script src="breeze.metadata-helper.js" type="application/javascript"></script>
<script src="breeze.labs.dataservice.abstractrest.js" type="application/javascript"></script>
<script src="breeze.labs.dataservice.sharepoint.js" type="application/javascript"></script>
````


###Step 2 - Configure SharePoint Data Service Adapter
For SharePoint 2013+, either on-premises deployments or SharePoint Online deployments in Office 365, use the following code to configure the SharePoint 2013+ data service adapter:

  ````javascript
  // configure breeze to use SharePoint OData service
  var dsAdapter = breeze.config.initializeAdapterInstance('dataService',
                                                          'SharePointOData',
                                                          true);

  // tell breeze how to get the security validation token
  //  for HTTP POST & DELETE calls
  // NOTE: Setting the request digest is not required when using OAuth tokens
  //  for authentication. The request digest is used when cookies are used for
  //  authentication to protect against XSRF. When OAuth tokens are used, there
  //  is no XSRF issue as there are no cookies. Version 0.6.3 of the adapter
  //  added conditional logic to omit the `X-RequestDigest` header in the HTTP
  //  request if this method is not set.
  dsAdapter.getRequestDigest = function () {
    return jQuery('#__REQUESTDIGEST').val();
  };
  ````

For SharePoint 2010, use the following code to configure the SharePoint 2010 data service adapter (*note the name of the adapter*):

  ````javascript
  // configure breeze to use SharePoint OData service
  var dsAdapter = breeze.config.initializeAdapterInstance('dataService',
                                                          'SharePointOData2010',
                                                          true);
  ````

###Step 3 - Create & Populate the BreezeJS Metadata Store
````javascript
// create a new breeze metadata store
metadataStore = new breeze.MetadataStore();

// setup a helper to create entities
var namespace = '';
var helper = new breeze.config.MetadataHelper(namespace,
                                              breeze.AutoGeneratedKeyType.Identity);

//define a new function that uses the helper to create a new entity type in the metadata store
// and create a default select so we don't have to create the OData $select each time
var addType = function(typeDef){
  var entityType = helper.addTypeToStore(metadataStore,typeDef);
  addDefaultSelectType(entityType);
  return entityType;
};

//add 'defaultSelect' custom metadata that selects for all mapped data properties that could be used by SharePoint dataservice
// adapter to exclude unwanted property data in query payload
function addDefaultSelectType(type){
  var custom = type.custom;
  //exit if already defined
  if(custom && custom.defaultSelect != null){
    return;
  }

  var select = [];
  type.dataProperties.forEach(function(prop){
    if(!prop.isUnmapped){
      select.push(prop.name);
    }
  });
  if(select.length) {
    if(!custom){
      type.custom = custom = {};
    }
    custom.defaultSelect = select.join(',');
  }
  return type;
}

// create entity for contacts
var contactEntity = {
  name: 'Contacts',
  // the defaultResourceName endpoint will vary based on the entity endpoint & SharePoint version
  defaultResourceName: "getbytitle('Contacts')/items",
  dataProperties: {
    Id: { type: breeze.DataType.Int32 },
    FirstName: { nullable: false },
    Title: { nullable: false },
    Email: {
      nullable: false,
      validators: [breeze.Validator.emailAddress()]
    }
  }
};

// add entity to metadata store
addType(contactEntity);
````

> Note that it is very important that the **name** of the entity matches exactly the name of the SharePoint list the entity is coming from. If it doesn't Breeze will not be able to associate data from an HTTP GET it makes with the entity defined in the metadata store.



###Step 4 - Initialize BreezeJS
````javascript
// get reference to contact entity type
var contactType = metadataStore.getEntityType('Contacts');

// create the data service
var dataService = new breeze.DataService({
  // tell breeze the root REST endpoint to use
  //  since we only are using lists, point to that
  // NOTE this will depend on the SharePoint version - for instance the
  //  _spPageContextInfo object is only present in SharePoitn 2013
  //  and the '/_api/' endpoint is only used in SharePoint 2013 while
  //  '/_vti_bin/listdata.svc' is used in SharePoint 2010
  serviceName: _spPageContextInfo.webAbsoluteUrl + '/_api/web/lists/',
  // tell breeze not to interrogate sharepoint for it's
  //  massive OData $metadata response... we created it manually
  hasServerMetadata: false
});

// create an instance of the entity manager
var entityManager = new breeze.EntityManager({
  dataService: dataService,
  // tell breeze where the metadata is
  metadataStore: metadataStore
});
````



###Step 5 - Perform a Query
For details and examples of querying and handling success/failures, please see the [breeze documentation](http://breeze.github.io/doc-js/query.html). Here is a simple example utilizing the entity created above:
````javascript
entityManager.executeQuery(
  breeze.EntityQuery.from(contactType.defaultResourceName)
).then(function(d){
  //do something with d.results
}).fail(function(e){
  //handle e
});
````



Advanced Examples
------------------

##Expand related entities
Many times you will have related items that you will want to query at the same time. For instance, you may have a list serving as a lookup and you would like to fill those entities at the same time as you query the list containing the lookup column (Eager Loading). You can do this by establishing those relationships through [navigationProperties](http://breeze.github.io/doc-js/navigation-properties.html):
````javascript
//Establish your relationships during the setup of your Metadata Store
addType({
  name: 'Courses',
  defaultResourceName: "getbytitle('Courses')/items",
  dataProperties: {
    Id: { type: breeze.DataType.Int32 },
    Title: { nullable: false },
    DepartmentId: { type: breeze.DataType.Int32 }
  },
  navigationProperties: {
    Department: 'Departments'
  }
});
var courseType = metadataStore.getEntityType('Courses');

addType({
  name: 'Departments',
  defaultResourceName: "getbytitle('Departments')/items",
  dataProperties: {
    Id: { type: breeze.DataType.Int32 },
    Title: { nullable: false }
  },
  navigationProperties: {
    Courses: {
      type: 'Courses',
      hasMany: true
    }
  }
});
var departmentType = metadataStore.getEntityType('Departments');
````

Above, we have a basic Departments list. We also have a Courses list with a lookup column using the Departments list. Later, if you'd like to Eager Load departments when you query Courses you can use Expand:
````javascript
entityManager.executeQuery(
  breeze.EntityQuery.from(courseType.defaultResourceName)
    .select(courseType.custom.defaultSelect + ',Department.Id,Department.Title')
    .expand('Department')
).then(function(d){
  //do something with d.results
}).fail(function(e){
  //handle e
});
````



Reference Examples
------------------
- **[BreezeSP2013Sample](https://github.com/andrewconnell/sp-o365-rest/tree/master/BreezeSP2013Sample)**: Demonstrates usage within SharePoint 2013. This sample is a SharePoint Hosted App which can be used in either an on-premises or Office 365 deployment.
- **[BreezeSP2010Sample](https://github.com/andrewconnell/sp-o365-rest/tree/master/BreezeSP2010Sample)**: Demonstrates usage within SharePoint 2010. This sample is a fully-trusted farm solution.



Supported SharePoint Versions
-----------------------------
- SharePoint 2013
  + Office 365 / SharePoint Online: RTM -> present version
  + SharePoint 2013 On-Premises: RTM -> present version
- SharePoint 2010
  + Data service adapter v0.7.0
- SharePoint 2007
  + Support not planned



Supported SharePoint Versions
-----------------------------
- All evergreen browsers (Chrome, Firefox)
- Internet Explorer 9+


References
----------
> - Documentation on the BreezeJS site for more information & background: [BreezeJS.com - SharePoint SPA](http://www.breezejs.com/samples/introduction-single-page-apps-sharepoint)
> - [Andrew Connell's](http://www.andrewconnell.com) session on using BreezeJS with SharePoint: [BreezeJS Makes Client-Side SharePoint 2013 REST Development a... BREEZE!](https://github.com/andrewconnell/pres-sp15rest-breeze).
